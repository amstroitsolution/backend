name: Deploy Backend to VPS

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create deployment archive
      run: |
        # Exclude node_modules and other unnecessary files
        tar --warning=no-file-changed -czf backend-deploy.tar.gz \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.env' \
          --exclude='*.log' \
          --exclude='.github' \
          . || [ $? -eq 1 ]
        ls -lh backend-deploy.tar.gz
      
    - name: Deploy to VPS via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT }}
        source: "backend-deploy.tar.gz"
        target: "/tmp/"
        timeout: 60s
        command_timeout: 15m
        
    - name: Extract and deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT }}
        timeout: 60s
        command_timeout: 15m
        script: |
          echo "ğŸš€ Starting backend deployment..."
          
          # Create backend directory if it doesn't exist
          mkdir -p /domains/api.yashper.com/backend
          
          # Create backup
          if [ -d "/domains/api.yashper.com/backend" ]; then
            echo "ğŸ“¦ Creating backup..."
            tar -czf /tmp/backend-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /domains/api.yashper.com/backend . 2>/dev/null || true
          fi
          
          # Extract new code
          echo "ğŸ“‚ Extracting new code..."
          tar -xzf /tmp/backend-deploy.tar.gz -C /domains/api.yashper.com/backend/
          
          # Navigate to backend directory
          cd /domains/api.yashper.com/backend
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production
          
          # Restart PM2 process
          echo "ğŸ”„ Restarting backend service..."
          if pm2 list | grep -q "yashper-backend"; then
            pm2 restart yashper-backend
          else
            pm2 start server.js --name yashper-backend
          fi
          
          pm2 save
          
          # Cleanup
          echo "ğŸ§¹ Cleaning up..."
          rm -f /tmp/backend-deploy.tar.gz
          
          # Verify deployment
          echo "âœ… Verifying deployment..."
          sleep 3
          if pm2 list | grep -q "yashper-backend.*online"; then
            echo "âœ… Backend deployed successfully!"
            echo "ğŸŒ API: https://api.yashper.com"
          else
            echo "âŒ Deployment failed - PM2 process not running!"
            pm2 logs yashper-backend --lines 20
            exit 1
          fi
